<% if !IssueStatus.exists?(name: 'Backlog')
	IssueStatus.create(name: 'Backlog')
end %>
<!-- Expansion code by PSL (http://stackoverflow.com/questions/16926752/expand-collapse-table-rows-with-jquery), edited by Summer; Sortable swap code by Dmytrii Nagirniak (http://stackoverflow.com/questions/2263687/jquery-sortable-obtain-2-elements-being-swapped), edited by Summer -->
<!-- TASKBOARD VIEW -->
<%# early javascript before common.hs %>
<%- controller.rb_jquery_plugins = capture do %>
  <%= javascript_include_tag(
    'jquery/jquery.multiselect.js', 'jquery/jquery.qtip.pack.js', 'jquery/jquery.qtip.setup.js',
     :plugin => 'redmine_backlogs')
  %>
<%- end %>
<% content_for :head_tags do %>
  <%= javascript_include_tag(
    'show_main', 'board_updater', 'taskboard_updater', 'taskboard', 'model', 'issue', 'task', 'impediment',
     :plugin => 'redmine_backlogs')
  %>
  <%= stylesheet_link_tag 'jquery/jquery.qtip.css', :plugin => 'redmine_backlogs' %>
  <%= stylesheet_link_tag 'jquery/jquery.multiselect.css', :plugin => 'redmine_backlogs' %>
  <%= stylesheet_link_tag 'taskboard.css', :plugin => 'redmine_backlogs', :media => 'print,screen' %>
  <%= stylesheet_link_tag 'taskboard_print.css', :plugin => 'redmine_backlogs', :media => 'print' %>

  <script type="text/javascript"
          src="<%= url_for(:controller => 'rb_server_variables',
                           :action => 'sprint', :sprint_id => @sprint.id,
                           :context => 'taskboard',
                           :format => 'js') %>">
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <style>
	tr.header
	{
	  white-space: nowrap;
	  -moz-border-radius:5px 5px 0px 0px;
	  -webkit-border-radius:5px 5px 0px 0px;
	  border-radius:5px 5px 0px 0px;
	  background-color:#CCCCCC;
	  background: -webkit-gradient(linear, left top, left bottom, from(#EEE), to(#CCC));
	  background: -moz-linear-gradient(top, #EEE, #CCC);
	  filter:progid:DXImageTransform.Microsoft.Gradient(Enabled=1,GradientType=0,StartColorStr=#EEEEEE,EndColorStr=#CCCCCC);
	  position:relative;
	  white-space: nowrap;
	  height:30px;
	  border-bottom: 1px solid #AAAAAA
	}

   </style>

	<script type="text/javascript">
	var prevPagesOrder = JSON.parse("<%= !@sprint.orderArray.blank? ? escape_javascript(@sprint.orderArray.to_json.html_safe) : "[]" %>");
	$(document).ready(function(){
	if(prevPagesOrder.length > 1)
	{
		for (var i = 1; i < prevPagesOrder.length; i++)
		{
			var numStr = prevPagesOrder[i];
			if($(".swimhead."+numStr).length && $(".list."+numStr).length)
			{
				var j = i-1;
				var numStr2 = prevPagesOrder[j];

				while(!($(".swimhead."+numStr2).length && $(".list."+numStr2).length) && j > 0)
				{
					j--;
					numStr2 = prevPagesOrder[j];
				}
				if($(".swimhead."+numStr2).length && $(".list."+numStr2).length)
				{
					$(".swimhead."+numStr).insertAfter($(".swimhead."+numStr2));
					$(".list."+numStr).insertAfter($(".list."+numStr2));
				}
			}
		}
	}
	$('#taskHeader').click(function(){
		 $(this).toggleClass('expand').nextUntil('tr.header').slideToggle(100);
		 $("#taskboard").slideToggle(100);
		 if($(this).hasClass('expand'))
		 {
			$(".taskHead").html('<span class="sign fa fa-angle-down" id="taskSign"></span> Task Board');
		 }
		 else
		 {
			$(".taskHead").html('<span class="sign fa fa-angle-right" id="taskSign"></span> Expand to show Task Board...');
		 }
	});
	$('#kanbanHeader').click(function(){
		 $(this).toggleClass('expand').nextUntil('tr.header').slideToggle(100);
		 $("#kanban").slideToggle(100);
		 if($(this).hasClass('expand'))
		 {
			$(".kanbanHead").html('<span class="sign fa fa-angle-down" id="kanbanSign"></span> Kanban Board');
		 }
		 else
		 {
			$(".kanbanHead").html('<span class="sign fa fa-angle-right" id="kanbanSign"></span> Expand to show Kanban Board...');
		 }
	});
	$('.kanbanlane').sortable( 
	{ 
	items: "> td:not(:first)",
	start: function(event, ui) {
            prevPagesOrder = $(this).sortable('toArray');
        },
	stop: function(event,ui)
		{ 
			var currentOrder = $(this).sortable('toArray');
            var first = ui.item[0].id;
            var second = prevPagesOrder[currentOrder.indexOf(first)];
			var numStr = first;
			var numStr2 = second;
			if(first != null && second != null && first != "" && second != "" && first != second)
			{
				if(currentOrder.indexOf(first) > currentOrder.indexOf(second))
				{
					$(".list."+numStr).insertAfter($(".list."+numStr2));
				}
				else
				{
					$(".list."+numStr).insertBefore($(".list."+numStr2));
				}
			}
			if(second == null || second == "")
			{
				numStr2 = prevPagesOrder[prevPagesOrder.length-1];
				$(".list."+numStr).insertAfter($(".list."+numStr2));
			}
			$.ajax({
			  type: "POST",
			  url: "<%= @sprint.id %>/order/",
			  data: { orderArray: JSON.stringify(currentOrder) },
			  //success: function() { alert("Success!"); }
			});
		}
	} );
	});
   </script>
  
  <%# Usability: display default cursor if tasks cannot be dragged %>
  <% unless User.current.allowed_to?(:update_tasks, @project) %>
    <style type="text/css">
    #taskboard .issue{cursor:default;}
    </style>
  <% end %>
<% end %>

<% content_for :breadcrumbs do %>
  <% unless Backlogs.setting[:show_redmine_std_header] %>
    <%= link_to l(:label_master_backlog), :controller => "rb_master_backlogs", :action => "show", :project_id => @project %>
    <%= breadcrumb_separator %>
  <% end %>
  <%= h @sprint.name %>
<% end %>

<%- content_for :view_specific_users do %>
<span id="userselect">
<ul style="list-style:none; margin:0px">
  <li><label>
    <select class="userfilter" size="5" name="filter-user-selection" multiple="multiple" title="User selection">
      <option value='s'>Show empty Stories</option>
      <option value='c'>Show closed Stories</option>
      <optgroup label="Users">
      <% @project.assignable_users.sort.each do |member| %>
        <option value="<%= member.id %>"> <%= member.name %></option>
      <% end %>
      </optgroup>
      </select>
  </label></li>
</ul>
<br style="clear:both" />
</span>
<%- end %>

<%- content_for :view_specific_links do %>

  <span id="sprintestimatedhours">(<%= @sprint.estimated_hours.to_f %> estimated <%= l(:label_hours) %>)</span>
  <% if @sprint.has_burndown? %>
    <a id='show_charts'><%= l(:label_burndown) %></a>
  <% end %>
  <span id="col_width"><%= l(:label_column_width) %>: <input name="col_width"/></span>
  <a id="disable_autorefresh">Disable Auto-refresh</a>
  <a id="refresh">Refresh</a>
<%- end %>

<%- content_for :main do %>
<span id="userid" style="visibility:hidden;"><%= User.current.id %></span>
<table style = "width:100%; table-layout:fixed;">
<tr  class="header expand" id="taskHeader">
  <th class="taskHead"><span class="sign fa fa-angle-down" id="taskSign"></span> Task Board</th>
</tr>
</table>
<div id="taskboard" style = "overflow-x:scroll;">
	<% if !@sprint.open? %>
			<div style="text-align:center;vertical-align:middle;color:#000000;font-size:14px;font-weight: bold;width=100%;background-color:#ff3424">
				Completed Sprint (Read Only)
			</div>
	<% end %>
	
  <table id="board_header" cellspacing="0">
	
    <tr>
      <td><%= l(:backlogs_story) %></td>
      <%- @statuses.each do |status| %>
	  <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
	  <% if Setting.plugin_redmine_project_issue_statuses == nil || Setting.plugin_redmine_project_issue_statuses == ""
		  Setting.plugin_redmine_project_issue_statuses = {'issueStatusToKanban' => {}}
		end 
		if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
		  Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
		end
		if (status.name == "Backlog" || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'].has_key?(status.id))
			if(status.name != "Backlog" && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].respond_to?('include?') && !Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].empty? && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].include?(@project.id) && (Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].respond_to?('include?') && Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].include?(@project.id) || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id] == @project.id))
			%>
				
		<%	end
		else %>
			<td class="swimlane"><%= h status.name %></td>
		<% end
		%>
	  <% else %>
		<td class="swimlane"><%= h status.name %></td>
	  <% end %>
      <%- end %>
    </tr>
  </table>

  <table id="impediments" class="board" cellspacing="0">
    <tr>
      <td><div class="label_sprint_impediments">
				<div id="left" style="width: 87.5%; height:100%;display:table-cell;height: 100%; border-right:1px dotted #CFCFCF;margin:5px;
						padding:5px;">
					<%= l(:label_sprint_impediments) %>
				</div>
				<div id="right" style="width: 12.5%; display:table-cell;height: 100%; text-align:center; margin-left: auto;
						margin-right: auto; vertical-align: middle;">
					<% if User.current.allowed_to?(:create_impediments, @project) && @sprint.open? %>
            <span class="add_new">
              <%= image_tag("plusSignIcon.svg", :alt => "+", :style => "width:100%;height:100%;", :plugin => 'redmine_backlogs') %>
							Add Imp.
            </span>
					<% end %>
				</div>
				<br style="clear:both;"/>
			</div></td>
      <%- @statuses.each do |status| %>
	  <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
	  <% if Setting.plugin_redmine_project_issue_statuses == nil || Setting.plugin_redmine_project_issue_statuses == ""
		  Setting.plugin_redmine_project_issue_statuses = {'issueStatusToKanban' => {}}
		end 
		if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
		  Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
		end
		if (status.name == "Backlog" || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'].has_key?(status.id))
			if(status.name != "Backlog" && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].respond_to?('include?') && !Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].empty? && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].include?(@project.id) && (Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].respond_to?('include?') && Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].include?(@project.id) || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id] == @project.id))
			%>
				
		<%	end
		else %>
			<td class="swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="impcell_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="impediments">
				<%= render :partial => "rb_impediments/impediment", :collection => @sprint.impediments.select{|impediment| impediment.status_id==status.id} %>
			</td>
		<% end
		%>
	  <% else %>
		<td class="swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="impcell_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="impediments">
				<%= render :partial => "rb_impediments/impediment", :collection => @sprint.impediments.select{|impediment| impediment.status_id==status.id} %>
			</td>
	  <% end %>
      <%- end %>
    </tr>
  </table>

  <table id="tasks" class="board" cellspacing="0">
    <%- @sprint.stories.each do |story| %>
    <tr id="swimlane-<%= story.id %>" class="story-swimlane">
      <td>
        <div class="story <%= mark_if_closed(story) %>" <%= build_inline_style(story).html_safe %>>
          <!--<div class="subject">-->
					<div id="storyleft" class="subject" style="width: 87.5%; height: 100%;display:table-cell;border-right:1px dotted #CFCFCF;margin:5px;
							padding:5px;">
						<div class="id story_tooltip_ajax">
							<div class="tooltip_text"></div>
							<%= link_to story.id, {:controller => 'issues', :action => 'show', :id => story.id}, { :target => "_blank" } %>
							<div class="v"><%= story.id %></div>
							<span class="assignee">
              <%= assignee_name_or_empty(story) %>
            </span>
							<span class="remaininghours">(<%= story.remaining_hours.to_f %> <%= l(:label_hours) %>)</span>
						</div>
						<%= h story.subject %>
					</div>
					<div id="storyright" style="width: 12.5%; display:table-cell; height: 100%; text-align:center; margin-left: auto;
							margin-right: auto; vertical-align: middle;">
						<% if User.current.allowed_to?(:create_tasks, @project) && @sprint.open? %>
            <span class="add_new">
              <%= image_tag("plusSignIcon.svg", :alt => "+", :style => "width:100%;height:100%;", :plugin => 'redmine_backlogs') %>
							Add Task
            </span>
						<% end %>
					</div>
					<br style="clear:both;"/>
					<!--</div>-->
          <%- if @project != story.project %>
            <div class="id project">
              <span class="t"><%= h story.project %></span>
              <span class="v"><%= story.project.id %></span>
            </div>
          <%- end %>
          <div class="story_points editable" fieldname="story_points" fieldlabel="<%=l(:field_story_points)%>"><%= story.story_points %></div>
        </div>
      </td>
      <%- @statuses.each do |status| %>
	  <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
	  <% if Setting.plugin_redmine_project_issue_statuses == nil || Setting.plugin_redmine_project_issue_statuses == ""
		  Setting.plugin_redmine_project_issue_statuses = {'issueStatusToKanban' => {}}
		end 
		if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
		  Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
		end
		if (status.name == "Backlog" || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'].has_key?(status.id))
			if(status.name != "Backlog" && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].respond_to?('include?') && !Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].empty? && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].include?(@project.id) && (Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].respond_to?('include?') && Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].include?(@project.id) || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id] == @project.id))
			%>
				
		<%	end
		else %>
			<td class="swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="<%= story.id %>_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="<%= story.project.id %>">
				<%= render_rb_task_collection(story.descendants.select{|task| task.status_id==status.id}) %>
			  </td>
		<% end
		%>
	   <% else %>
		<td class="swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="<%= story.id %>_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="<%= story.project.id %>">
				<%= render_rb_task_collection(story.descendants.select{|task| task.status_id==status.id}) %>
			  </td>
	  <% end %>
      <%- end %>
    </tr>
    <%- end %>
  </table>
</div>
<%- end %>

<%- content_for :helpers do %>
  <select class="time_entry_user_id template" id="time_entry_user_id_options">
    <%- users_allowed_to_log_on_task.each do |u| %>
      <option value="<%= u[1] %>"><%= u[0] %></option>
    <%- end %>
  </select>

  <select class="priority_id template" id="priority_id_options">
    <%- IssuePriority.all.each do |p| %>
    <option value="<%= p.id %>"><%= h p.name %></option>
    <%- end %>
  </select>

  <select class="assigned_to_id template" id="assigned_to_id_options">
    <option value="" color="#AAAAAA" color_light="#E0E0E0"> </option>
    <%= users_assignable_options_for_select(@project.assignable_users) %>
  </select>
  <div id="task_template">
    <%= render :partial => "rb_tasks/task", :object => RbTask.new %>
  </div>
  <div id="impediment_template">
    <%= render :partial => "rb_impediments/impediment", :object => RbTask.new %>
  </div>
  <!-- end of templates -->
  <div id="issue_editor"> </div>
  <div class="meta" id="last_updated"><%= date_string_with_milliseconds( (@last_updated.blank? ? Time.now : @last_updated.updated_on) )  %></div>
  <div id="charts"> </div>
  <div id="preloader">
    <div id="spinner"> </div>
    <div id="warning"> </div>
  </div>
<%- end %>

<% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
<!-- KANBAN VIEW -->
<% content_for :head_tags do %>
  <%= javascript_include_tag(
    'show_main_kanban', 'kanban_updater', 'kanban',
     :plugin => 'redmine_backlogs')
  %>
  <%= stylesheet_link_tag 'kanban.css', :plugin => 'redmine_backlogs', :media => 'print,screen' %>
  
  </script>
  <%# Usability: display default cursor if tasks cannot be dragged %>
  <% unless User.current.allowed_to?(:update_tasks, @project) && @sprint.open? %>
    <style type="text/css">
    #kanban .issue{cursor:default;}
    </style>
  <% end %>
<% end %>

<%- content_for :main do %>
<span id="userid" style="visibility:hidden;"><%= User.current.id %></span>

<table style = "width:100%; table-layout:fixed;">
<tr  class="header expand" id="kanbanHeader">
  <th class="kanbanHead"><span class="sign fa fa-angle-down" id="kanbanSign"></span> Kanban Board</th>
</tr>
</table>

<div id="kanban" style = "overflow-x:scroll;">

  <table id="board_header" cellspacing="0">

    <tr class="kanbanlane">
      <td class="swimlane"><%= l(:backlogs_backlog) %></td>
      <%- @statuses.each do |status| %>
	  <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
	  <% if Setting.plugin_redmine_project_issue_statuses == nil || Setting.plugin_redmine_project_issue_statuses == ""
		  Setting.plugin_redmine_project_issue_statuses = {'issueStatusToKanban' => {}}
		end 
		if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
		  Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
		end
	 if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
		 Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
	 end
		if (status.name == "Backlog" || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'].has_key?(status.id))
			if(status.name != "Backlog" && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].respond_to?('include?') && !Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].empty? && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].include?(@project.id) && (Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].respond_to?('include?') && Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].include?(@project.id) || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id] == @project.id))
			%>
				<td class="swimlane swimhead <%= status.id %>" id="<%= status.id %>"><%= h status.name %></td>
		<%	end
		%>
		<% end
		%>
	  
	  <% else %>
		<td class="swimlane swimhead <%= status.id %>"><%= h status.name %></td>
	  <% end %>
      <%- end %>
    </tr>
	
	
  </table>

  <table id="impediments" class="board" cellspacing="0">
    <tr>
      
    </tr>
  </table>

  <table id="tasks" class="board" cellspacing="0">
    <% issues = Issue.where(project_id: @project.id) %>
    <tr id="swimlane-kanban" class="story-swimlane">
	  
	  <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
		<% status = IssueStatus.find_by name: 'Backlog' %>
		      <td class="swimlane list <%= status.is_closed? ? 'closed' : '' %>" id="_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="<%= @project.id %>">
				<div class="label_kanban_new">
						<div id="left" style="width: 87.5%;display:table-cell;height: 100%; border-right:1px dotted #CFCFCF;margin:5px;padding:5px;">
						New
						</div>
						<div id="right" style="width: 12.5%; display:table-cell;height: 100%; text-align:center; margin-left: auto;margin-right: auto; vertical-align: middle;">
						<% if User.current.allowed_to?(:create_tasks, @project) && @sprint.open? %>
								<span class="add_new">
								<%= image_tag("plusSignIcon.svg", :alt => "+", :style => "width:100%;height:100%;", :plugin => 'redmine_backlogs') %>
								Add Task
								</span>
						<% end %>
						</div>
						<br style="clear:both;"/>
				</div>
				<%= render_rb_task_collection(issues.select{|task| !task.parent_id && task.status_id==status.id}) %>
              </td>
	  <% end %>
      <%- @statuses.each do |status| %>
        <% if(Setting.respond_to? :plugin_redmine_project_issue_statuses) %>
          <% if Setting.plugin_redmine_project_issue_statuses == nil || Setting.plugin_redmine_project_issue_statuses == ""
            Setting.plugin_redmine_project_issue_statuses = {'issueStatusToKanban' => {}}
          end 
          if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
            Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
          end
				 if Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == nil || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] == ""
					 Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'] = {}
				 end
          if (status.name == "Backlog" || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'].has_key?(status.id))
            if(status.name != "Backlog" && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].respond_to?('include?') && !Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].empty? && Setting.plugin_redmine_project_issue_statuses['issueStatusToProject'][status.id].include?(@project.id) && (Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].respond_to?('include?') && Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id].include?(@project.id) || Setting.plugin_redmine_project_issue_statuses['issueStatusToKanban'][status.id] == @project.id))
            %>
              <td class="swimlane list <%= status.is_closed? ? 'closed' : '' %> <%= status.id %>" id="_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="<%= @project.id %>">
                <%= render_rb_task_collection(issues.select{|task| !task.parent_id && task.status_id==status.id}) %>
              </td>
            <%end
            %>
          <% end
          %>
        <% else %>
          <td class="swimlane list <%= status.is_closed? ? 'closed' : '' %> <%= status.id %>" id=">_<%= status.id %>" -rb-status-id="<%= status.id %>" -rb-project-id="<%= @project.id %>">
              <%= render_rb_task_collection(issues.select{|task| !task.parent_id && task.status_id==status.id}) %>
          </td>
        <% end %>
      <% end %>
    </tr>
    
  </table>
</div>
<%- end %>

<%- content_for :helpers do %>
  <select class="time_entry_user_id template" id="time_entry_user_id_options">
    <%- users_allowed_to_log_on_task.each do |u| %>
      <option value="<%= u[1] %>"><%= u[0] %></option>
    <%- end %>
  </select>

  <select class="priority_id template" id="priority_id_options">
    <%- IssuePriority.all.each do |p| %>
    <option value="<%= p.id %>"><%= h p.name %></option>
    <%- end %>
  </select>

  <select class="assigned_to_id template" id="assigned_to_id_options">
    <option value="" color="#AAAAAA" color_light="#E0E0E0"> </option>
    <%= users_assignable_options_for_select(@project.assignable_users) %>
  </select>
  <div id="task_template">
    <%= render :partial => "rb_tasks/task", :object => RbTask.new %>
  </div>
  
  <!-- end of templates -->
  <div id="issue_editor"> </div>
  <div class="meta" id="last_updated"><%= date_string_with_milliseconds( (@last_updated.blank? ? Time.now : @last_updated.updated_on) )  %></div>
  <div id="charts"> </div>
  <div id="preloader">
    <div id="spinner"> </div>
    <div id="warning"> </div>
  </div>
<%- end %>
<% end %>